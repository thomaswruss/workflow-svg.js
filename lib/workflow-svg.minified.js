"use strict";var WorkflowSVG=function(){function a(a,b){var f=a.group().attr({id:b.id});a.entities.push(f),b.backgroundcolor=b.backgroundcolor?b.backgroundcolor:"#f06",b.color=b.color?b.color:"#ffffff",b.radius=b.radius?b.radius:0,f.dragPoints=[],f.entity=f.rect(b.width,b.height).cx(b.width/2).cy(b.height/2).attr({fill:b.backgroundcolor}).radius(b.radius),f.entity.displaytype=b.displaytype,"operation"===b.displaytype&&f.entity.transform({rotate:45,origin:"center center"}),b.class&&f.entity.attr("class",b.class),f.text(b.text).cx(b.width/2).cy(b.height/2).attr({fill:b.color}).font({family:"Helvetica"}),f.arrows=f.group();var g=f.rect(b.width+50,b.height+50).cx(b.width/2).cy(b.height/2).attr({opacity:"0",fill:"#FFBF00"});"operation"===b.displaytype&&g.transform({rotate:45}),f.dragGroup=f.group();//dragabble area
var h=f.rect(b.width-20,b.height-20).cx(b.width/2).cy(b.height/2).attr({opacity:0});s.configuration.readonly||(h.draggable().on("dragmove.namespace",function(c){c.preventDefault();var e=c.detail.box;//to update json
a.grid.x.forEach(function(a){var b=e.cx-a.value;10>b&&-10<b?(e.cx=a.value,a.line.show()):"static"!=s.configuration.grid_type&&a.line.hide()}),a.grid.y.forEach(function(a){var b=e.cy-a.value;10>b&&-10<b?(e.cy=a.value,a.line.show()):"static"!=s.configuration.grid_type&&a.line.hide()}),f.cx(e.cx),f.cy(e.cy),b.x=f.x()+25,b.y=f.y()+25,d(a,u)}).attr({cursor:"grab"}).on("dragend",function(b){"static"!=s.configuration.grid_type&&(a.grid.y.forEach(function(a){return a.line.hide()}),a.grid.x.forEach(function(a){return a.line.hide()})),n("entity:moved",o(b))}).on("click",function(a){n("entity:clicked",o(a))}),g.on("mouseover",function(b){c(a,f,"top"),c(a,f,"right"),c(a,f,"bottom"),c(a,f,"left"),b.stopPropagation()}),a.on("mouseover",function(){f.dragPoints.forEach(function(a){t.includes(a)||a.remove()})})),f.move(b.x-25,b.y-25)}function b(){s.configuration.grid_x&&0<s.configuration.grid_x.length&&(s.configuration.grid_x.forEach(function(a){r.grid.x.push({value:a.value,line:r.gridGroup.polyline([[a.value,0],[a.value,r.height()]]).fill("none").stroke({color:a.color?a.color:"black",width:a.width?a.width:1,linecap:"round",linejoin:"round"})})}),"static"!=s.configuration.grid_type&&r.grid.x.forEach(function(a){return a.line.hide()})),s.configuration.grid_y&&0<s.configuration.grid_y.length&&(s.configuration.grid_y.forEach(function(a){r.grid.y.push({value:a.value,line:r.gridGroup.polyline([[0,a.value],[r.width(),a.value]]).fill("none").stroke({color:a.color?a.color:"black",width:a.width?a.width:1,linecap:"round",linejoin:"round"})})}),"static"!=s.configuration.grid_type&&r.grid.y.forEach(function(a){return a.line.hide()}))}function c(a,b,c){var e=i(b,c),f=j(b,c);b.dragPoints.push(b.dragGroup.circle(10,10).attr({fill:"white",stroke:"#d4d4d4",id:c}).move(e-5,f-5).on("mouseover",function(a){// make point bigger
this.transform({scale:2}),a.stopPropagation()}).on("click",function(){if(!!t.includes(this))t=[];else if(t.push(this),2==t.length){var b={id:"line-"+u.length,from:{element:t[0].parent().parent().attr("id"),point:t[0].attr("id")},to:{element:t[1].parent().parent().attr("id"),point:t[1].attr("id")}};u.push(b),s.lines.push(l(b)),d(a,u),t=[],n("line:added",b)}}).on("mouseout",function(a){t.includes(this)||this.transform({scale:1}),a.stopPropagation()}))}function d(a,b){b.forEach(function(b){return e(a,b)})}function e(a,b){var c="",d=s.configuration.line_color,e=a.findOne("#"+b.from.element),h=a.findOne("#"+b.to.element),k=g(b,e,h);c+=i(e,b.from.point)+","+j(e,b.from.point)+" ",k.forEach(function(a){return c+=a.x+","+a.y+" "}),c+="top"===b.to.point?i(h,b.to.point)+","+(j(h,b.to.point)-5)+" ":"right"===b.to.point?i(h,b.to.point)+5+","+j(h,b.to.point)+" ":"bottom"===b.to.point?i(h,b.to.point)+","+(j(h,b.to.point)+5)+" ":i(h,b.to.point)-5+","+j(h,b.to.point)+" ";b.polyline?b.polyline.plot(c):b.polyline=a.lines.polyline(c).fill("none").stroke({color:d,width:4,linecap:"round",linejoin:"round"}).on("click",function(a){n("line:clicked",a.target.id)}).attr("id",b.id);f(b,h,d)}function f(a,b,c){if(!a.to.arrow&&"default"===s.configuration.arrow_type){var d=i(b,a.to.point)+","+j(b,a.to.point)+" ";"top"===a.to.point?(d+=i(b,a.to.point)+7+","+(j(b,a.to.point)-14)+" ",d+=i(b,a.to.point)-7+","+(j(b,a.to.point)-14)+" "):"right"===a.to.point?(d+=i(b,a.to.point)+14+","+(j(b,a.to.point)-7)+" ",d+=i(b,a.to.point)+14+","+(j(b,a.to.point)+7)+" "):"bottom"===a.to.point?(d+=i(b,a.to.point)+7+","+(j(b,a.to.point)+14)+" ",d+=i(b,a.to.point)-7+","+(j(b,a.to.point)+14)+" "):(d+=i(b,a.to.point)-14+","+(j(b,a.to.point)-7)+" ",d+=i(b,a.to.point)-14+","+(j(b,a.to.point)+7)+" "),a.to.arrow=b.arrows.polygon(d).fill(c).stroke({width:1})}}function g(a,b,c){var d=[],e=j(b,a.from.point),f=j(c,a.to.point),g=i(b,a.from.point),k=i(c,a.to.point),l=h(a.from.point),m=h(a.to.point),n=l-m;return 0===n&&("top"===a.from.point?e<=f?(d.push({x:g,y:e-20}),d.push({x:k,y:e-20})):(d.push({x:g,y:f-20}),d.push({x:k,y:f-20})):"bottom"===a.from.point?e<=f?(d.push({x:g,y:f+20}),d.push({x:k,y:f+20})):(d.push({x:g,y:e+20}),d.push({x:k,y:e+20})):"left"===a.from.point?g<=k?(d.push({x:g-20,y:e}),d.push({x:g-20,y:f})):(d.push({x:k-20,y:e}),d.push({x:k-20,y:f})):g<=k?(d.push({x:k+20,y:e}),d.push({x:k+20,y:f})):(d.push({x:g+20,y:e}),d.push({x:g+20,y:f}))),(2===n||-2===n)&&("left"===a.from.point||"right"===a.from.point?e!==f&&(d.push({x:g+(k-g)/2,y:e}),d.push({x:g+(k-g)/2,y:f})):g!==k&&(d.push({x:g,y:f+(e-f)/2}),d.push({x:k,y:f+(e-f)/2}))),(1===n||-1===n||3===n||-3===n)&&("top"===a.from.point&&(e<=f?(d.push({x:g,y:e-20}),"left"===a.to.point?(d.push({x:k-20,y:e-20}),d.push({x:k-20,y:f})):(d.push({x:k+20,y:e-20}),d.push({x:k+20,y:f}))):d.push({x:g,y:f})),"bottom"===a.from.point&&(e>=f?(d.push({x:g,y:e+20}),"left"===a.to.point?(d.push({x:k-20,y:e+20}),d.push({x:k-20,y:f})):(d.push({x:k+20,y:e+20}),d.push({x:k+20,y:f}))):d.push({x:g,y:f})),"left"===a.from.point&&(e>f?"top"===a.to.point?(d.push({x:g-20,y:e}),d.push({x:g-20,y:f-20}),d.push({x:k,y:f-20})):d.push({x:k,y:e}):"top"===a.to.point?d.push({x:k,y:e}):(d.push({x:g-20,y:e}),d.push({x:g-20,y:f+20}),d.push({x:k,y:f+20}))),"right"===a.from.point&&(e>f?"top"===a.to.point?(d.push({x:g+20,y:e}),d.push({x:g+20,y:f-20}),d.push({x:k,y:f-20})):d.push({x:k,y:e}):"top"===a.to.point?d.push({x:k,y:e}):(d.push({x:g+20,y:e}),d.push({x:g+20,y:f+20}),d.push({x:k,y:f+20})))),d}function h(a){return"top"===a?0:"right"===a?1:"bottom"===a?2:3}function i(a,b){var c="operation"===a.entity.displaytype?k(a.entity.attr("width"),a.entity.attr("height")):a.entity.attr("width");return"right"===b?a.cx()+c/2:"top"===b||"bottom"===b?a.cx():a.cx()-c/2}function j(a,b){var c="operation"===a.entity.displaytype?k(a.entity.attr("width"),a.entity.attr("height")):a.entity.attr("height");return"right"===b?a.cy():"top"===b?a.cy()-c/2:"bottom"===b?a.cy()+c/2:a.cy()}function k(c,a){var b=Math.pow;return Math.sqrt(b(c,2)+b(a,2))}function l(a){return JSON.parse(JSON.stringify(a))}function m(){//clean up
//rendering
// needed to have no circular dependencies
r.entities.forEach(function(a){return a.remove()}),r.entities=[],u.forEach(function(a){return a.remove()}),u=[],r.grid.x.forEach(function(a){return a.line.remove()}),r.grid.y.forEach(function(){return x.line.remove()}),r.grid={x:[],y:[]},t=[],s.configuration||(s.configuration={}),s.configuration.readonly=!!s.configuration.readonly&&s.configuration.readonly,s.configuration.line_color=s.configuration.line_color?s.configuration.line_color:"#000000",s.configuration.arrow_type=s.configuration.arrow_type?s.configuration.arrow_type:"default",s.configuration.grid_x&&0<s.configuration.grid_x.length?s.configuration.grid_x.map(function(a){value:a.value?a.value:0;width:a.width?a.width:1;color:a.color?a.color:"black"}):s.configuration.grid_x=[],s.configuration.grid_y&&0<s.configuration.grid_y.length?s.configuration.grid_y.map(function(a){value:a.value?a.value:0;width:a.width?a.width:1;color:a.color?a.color:"black"}):s.configuration.grid_y=[],s.entities.map(function(a){a.displaytype=a.displaytype?a.displaytype:"entity","operation"===a.displaytype&&(a.height=a.width)}),b(),s.entities.forEach(function(b){return a(r,b)}),u=l(s.lines),d(r,u)}function n(a,b){null!==w[a]&&w[a]!==void 0&&w[a].forEach(function(a){return a(b)})}function o(a){var b="";return a&&a.target&&a.target.parentElement&&(b=a.target.parentElement.id),b}function p(a){s=l(a),v?m():SVG.on(document,"DOMContentLoaded",function(){m(),v=!0})}function q(){return s}var r,s={entities:[]},t=[],u=[],v=!1,w={};return{initalize:function(a,b,c){SVG.on(document,"DOMContentLoaded",function(){//grid
r=SVG().addTo(a).size(b,c),r.gridGroup=r.group(),r.grid={x:[],y:[]},r.entities=[],r.lines=r.group()})},update:p,register:function(a,b){(null===w[a]||w[a]===void 0)&&(w[a]=[]),w[a].push(b)},get:q}};
