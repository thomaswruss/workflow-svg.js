"use strict";var WorkflowSVG=function(){function a(a,d){var f=a.group().attr({id:d.id});a.entities.push(f),d.backgroundcolor=d.backgroundcolor?d.backgroundcolor:"#f06",d.color=d.color?d.color:"#ffffff",d.radius=d.radius?d.radius:0,f.dragPoints=[],f.entity=f.rect(d.width,d.height).cx(d.width/2).cy(d.height/2).attr({fill:d.backgroundcolor}).radius(d.radius),f.entity.displaytype=d.displaytype,"operation"===d.displaytype&&f.entity.transform({rotate:45,origin:"center center"}),d.class&&f.entity.attr("class",d.class),f.text(d.text).cx(d.width/2).cy(d.height/2).attr({fill:d.color}).font({family:"Helvetica"}),f.arrows=f.group();var g=f.rect(d.width+50,d.height+50).cx(d.width/2).cy(d.height/2).attr({opacity:"0",fill:"#FFBF00"});"operation"===d.displaytype&&g.transform({rotate:45}),f.dragGroup=f.group();//dragabble area
var h=f.rect(d.width-20,d.height-20).cx(d.width/2).cy(d.height/2).attr({opacity:0});r.configuration.readonly||(h.draggable().on("dragmove.namespace",function(b){b.preventDefault();var e=b.detail.box;//to update json
f.cx(e.cx),f.cy(e.cy),d.x=f.x()+25,d.y=f.y()+25,c(a,t)}).attr({cursor:"grab"}).on("dragend",function(a){m("entity:moved",n(a))}).on("click",function(a){m("entity:clicked",n(a))}),g.on("mouseover",function(c){b(a,f,"top"),b(a,f,"right"),b(a,f,"bottom"),b(a,f,"left"),c.stopPropagation()}),a.on("mouseover",function(){f.dragPoints.forEach(function(a){s.includes(a)||a.remove()})})),f.move(d.x-25,d.y-25)}function b(a,b,d){var e=h(b,d),f=i(b,d);b.dragPoints.push(b.dragGroup.circle(10,10).attr({fill:"white",stroke:"#d4d4d4",id:d}).move(e-5,f-5).on("mouseover",function(a){// make point bigger
this.transform({scale:2}),a.stopPropagation()}).on("click",function(){if(!!s.includes(this))s=[];else if(s.push(this),2==s.length){var b={id:"line-"+t.length,from:{element:s[0].parent().parent().attr("id"),point:s[0].attr("id")},to:{element:s[1].parent().parent().attr("id"),point:s[1].attr("id")}};t.push(b),r.lines.push(k(b)),c(a,t),s=[],m("line:added",b)}}).on("mouseout",function(a){s.includes(this)||this.transform({scale:1}),a.stopPropagation()}))}function c(a,b){b.forEach(function(b){return d(a,b)})}function d(a,b){var c="",d=r.configuration.line_color,g=a.findOne("#"+b.from.element),j=a.findOne("#"+b.to.element),k=f(b,g,j);c+=h(g,b.from.point)+","+i(g,b.from.point)+" ",k.forEach(function(a){return c+=a.x+","+a.y+" "}),c+="top"===b.to.point?h(j,b.to.point)+","+(i(j,b.to.point)-5)+" ":"right"===b.to.point?h(j,b.to.point)+5+","+i(j,b.to.point)+" ":"bottom"===b.to.point?h(j,b.to.point)+","+(i(j,b.to.point)+5)+" ":h(j,b.to.point)-5+","+i(j,b.to.point)+" ";b.polyline?b.polyline.plot(c):b.polyline=a.lines.polyline(c).fill("none").stroke({color:d,width:4,linecap:"round",linejoin:"round"}).on("click",function(a){m("line:clicked",a.target.id)}).attr("id",b.id);e(b,j,d)}function e(a,b,c){if(!a.to.arrow&&"default"===r.configuration.arrow_type){var d=h(b,a.to.point)+","+i(b,a.to.point)+" ";"top"===a.to.point?(d+=h(b,a.to.point)+7+","+(i(b,a.to.point)-14)+" ",d+=h(b,a.to.point)-7+","+(i(b,a.to.point)-14)+" "):"right"===a.to.point?(d+=h(b,a.to.point)+14+","+(i(b,a.to.point)-7)+" ",d+=h(b,a.to.point)+14+","+(i(b,a.to.point)+7)+" "):"bottom"===a.to.point?(d+=h(b,a.to.point)+7+","+(i(b,a.to.point)+14)+" ",d+=h(b,a.to.point)-7+","+(i(b,a.to.point)+14)+" "):(d+=h(b,a.to.point)-14+","+(i(b,a.to.point)-7)+" ",d+=h(b,a.to.point)-14+","+(i(b,a.to.point)+7)+" "),a.to.arrow=b.arrows.polygon(d).fill(c).stroke({width:1})}}function f(a,b,c){var d=[],e=i(b,a.from.point),f=i(c,a.to.point),j=h(b,a.from.point),k=h(c,a.to.point),l=g(a.from.point),m=g(a.to.point),n=l-m;return 0===n&&("top"===a.from.point?e<=f?(d.push({x:j,y:e-20}),d.push({x:k,y:e-20})):(d.push({x:j,y:f-20}),d.push({x:k,y:f-20})):"bottom"===a.from.point?e<=f?(d.push({x:j,y:f+20}),d.push({x:k,y:f+20})):(d.push({x:j,y:e+20}),d.push({x:k,y:e+20})):"left"===a.from.point?j<=k?(d.push({x:j-20,y:e}),d.push({x:j-20,y:f})):(d.push({x:k-20,y:e}),d.push({x:k-20,y:f})):j<=k?(d.push({x:k+20,y:e}),d.push({x:k+20,y:f})):(d.push({x:j+20,y:e}),d.push({x:j+20,y:f}))),(2===n||-2===n)&&("left"===a.from.point||"right"===a.from.point?e!==f&&(d.push({x:j+(k-j)/2,y:e}),d.push({x:j+(k-j)/2,y:f})):j!==k&&(d.push({x:j,y:f+(e-f)/2}),d.push({x:k,y:f+(e-f)/2}))),(1===n||-1===n||3===n||-3===n)&&("top"===a.from.point&&(e<=f?(d.push({x:j,y:e-20}),"left"===a.to.point?(d.push({x:k-20,y:e-20}),d.push({x:k-20,y:f})):(d.push({x:k+20,y:e-20}),d.push({x:k+20,y:f}))):d.push({x:j,y:f})),"bottom"===a.from.point&&(e>=f?(d.push({x:j,y:e+20}),"left"===a.to.point?(d.push({x:k-20,y:e+20}),d.push({x:k-20,y:f})):(d.push({x:k+20,y:e+20}),d.push({x:k+20,y:f}))):d.push({x:j,y:f})),"left"===a.from.point&&(e>f?"top"===a.to.point?(d.push({x:j-20,y:e}),d.push({x:j-20,y:f-20}),d.push({x:k,y:f-20})):d.push({x:k,y:e}):"top"===a.to.point?d.push({x:k,y:e}):(d.push({x:j-20,y:e}),d.push({x:j-20,y:f+20}),d.push({x:k,y:f+20}))),"right"===a.from.point&&(e>f?"top"===a.to.point?(d.push({x:j+20,y:e}),d.push({x:j+20,y:f-20}),d.push({x:k,y:f-20})):d.push({x:k,y:e}):"top"===a.to.point?d.push({x:k,y:e}):(d.push({x:j+20,y:e}),d.push({x:j+20,y:f+20}),d.push({x:k,y:f+20})))),d}function g(a){return"top"===a?0:"right"===a?1:"bottom"===a?2:3}function h(a,b){var c="operation"===a.entity.displaytype?j(a.entity.attr("width"),a.entity.attr("height")):a.entity.attr("width");return"right"===b?a.cx()+c/2:"top"===b||"bottom"===b?a.cx():a.cx()-c/2}function i(a,b){var c="operation"===a.entity.displaytype?j(a.entity.attr("width"),a.entity.attr("height")):a.entity.attr("height");return"right"===b?a.cy():"top"===b?a.cy()-c/2:"bottom"===b?a.cy()+c/2:a.cy()}function j(c,a){var b=Math.pow;return Math.sqrt(b(c,2)+b(a,2))}function k(a){return JSON.parse(JSON.stringify(a))}function l(){//default value for config
q.entities.forEach(function(a){return a.remove()}),q.entities=[],t.forEach(function(a){return a.remove()}),t=[],s=[],r.configuration||(r.configuration={}),r.configuration.readonly=!!r.configuration.readonly&&r.configuration.readonly,r.configuration.line_color=r.configuration.line_color?r.configuration.line_color:"#000000",r.configuration.arrow_type=r.configuration.arrow_type?r.configuration.arrow_type:"default",r.entities.map(function(a){a.displaytype=a.displaytype?a.displaytype:"entity","operation"===a.displaytype&&(a.height=a.width)}),r.entities.forEach(function(b){return a(q,b)}),t=k(r.lines),c(q,t)}function m(a,b){null!==v[a]&&v[a]!==void 0&&v[a].forEach(function(a){return a(b)})}function n(a){var b="";return a&&a.target&&a.target.parentElement&&(b=a.target.parentElement.id),b}function o(a){r=k(a),u?l():SVG.on(document,"DOMContentLoaded",function(){l(),u=!0})}function p(){return r}var q,r={entities:[]},s=[],t=[],u=!1,v={};return{initalize:function(a,b,c){SVG.on(document,"DOMContentLoaded",function(){q=SVG().addTo(a).size(b,c),q.entities=[],q.lines=q.group()})},update:o,register:function(a,b){(null===v[a]||v[a]===void 0)&&(v[a]=[]),v[a].push(b)},get:p}};
